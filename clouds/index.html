<!DOCTYPE html>
<html>
<head>
  <title>Clouds</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.js"></script>
  <script src="SkyShader.js"></script>

  <style type="text/css">
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #container {
      /*background: -webkit-linear-gradient(top, #04142e 0%, #1d508f 35%, #5299d1 50%, #1d508f 100%);*/
    }
  </style>
</head>
<body>
  <div id="container"></div>

  <script id="vs" type="x-shader/x-vertex">
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  </script>

  <script id="fs" type="x-shader/x-fragment">
    uniform sampler2D map;

    uniform vec3 fogColor;
    uniform float fogNear;
    uniform float fogFar;

    varying vec2 vUv;

    void main() {

      float depth = gl_FragCoord.z / gl_FragCoord.w;
      float fogFactor = smoothstep( fogNear, fogFar, depth );

      gl_FragColor = texture2D( map, vUv );
      gl_FragColor.w *= pow( gl_FragCoord.z, 20.0 );
      gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );

    }
  </script>

  <script>
    var container;
    var camera, scene, renderer;
    var mesh, geometry, material;

    var mouseX = 0, mouseY = 0;
    var start_time = Date.now();

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    init();

    function init() {

      container = document.getElementById( 'container' );

      camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 2000000 );

      camera.position.y = 15;
      camera.position.z = 2000;

      scene = new THREE.Scene();

      geometry = new THREE.Geometry();

      var texture = THREE.ImageUtils.loadTexture( 'textures/cloud.png', null, animate );
      texture.magFilter = THREE.LinearMipMapLinearFilter;
      texture.minFilter = THREE.LinearMipMapLinearFilter;

      var fog = new THREE.Fog( 0xffffff, - 100, 3000);

      material = new THREE.ShaderMaterial({

        uniforms: {

          "map": { type: "t", value: texture },
          "fogColor" : { type: "c", value: fog.color },
          "fogNear" : { type: "f", value: fog.near },
          "fogFar" : { type: "f", value: fog.far },

        },
        vertexShader: document.getElementById( 'vs' ).textContent,
        fragmentShader: document.getElementById( 'fs' ).textContent,
        depthWrite: false,
        depthTest: false,
        transparent: true

      });

      var plane = new THREE.Mesh( new THREE.PlaneGeometry( 64, 64 ) );

      for ( var i = 0; i < 8000; i++ ) {
        plane.position.x = Math.random() * 1000 - 500;
        plane.position.y = - Math.random() * Math.random() * 200 - 15;
        plane.position.z = i;

        plane.rotation.z = Math.random() * Math.PI;

        plane.scale.x = plane.scale.y = Math.random() * Math.random() * 1.5 + 0.5;

        plane.updateMatrix();

        geometry.merge(plane.geometry, plane.matrix);
      }

      mesh = new THREE.Mesh( geometry, material );
      scene.add( mesh );

      mesh = new THREE.Mesh( geometry, material );
      mesh.position.z = - 8000;
      scene.add( mesh );

      sky = new THREE.Sky();
      scene.add( sky.mesh );

      sunSphere = new THREE.Mesh( new THREE.SphereGeometry( 20000, 30, 30 ),
        new THREE.MeshBasicMaterial({color: 0xffffff, wireframe: false }));
      sunSphere.position.y = -700000;
      sunSphere.visible = true;
      scene.add( sunSphere );

      effectController  = {
        turbidity: 10,
        reileigh: 1,
        mieCoefficient: 0.005,
        mieDirectionalG: 0.8,
        luminance: 1,
        inclination: 0.49, // elevation / inclination
        azimuth: 0.25, // Facing front,
        sun: true
      }

      var distance = 400000;

      updateSun = function () {
        var uniforms = sky.uniforms;
        uniforms.turbidity.value = effectController.turbidity;
        uniforms.reileigh.value = effectController.reileigh;
        uniforms.luminance.value = effectController.luminance;
        uniforms.mieCoefficient.value = effectController.mieCoefficient;
        uniforms.mieDirectionalG.value = effectController.mieDirectionalG;
        var theta = Math.PI * (effectController.inclination - 0.5);
        var phi = 2 * Math.PI * (effectController.azimuth - 0.5);
        sunSphere.position.x = distance * Math.cos(phi);
        sunSphere.position.y = distance * Math.sin(phi) * Math.sin(theta);
        sunSphere.position.z = distance * Math.sin(phi) * Math.cos(theta);
        sunSphere.visible = effectController.sun;
        sky.uniforms.sunPosition.value.copy(sunSphere.position);
      }

      updateSun();

      renderer = new THREE.WebGLRenderer( { antialias: false, alpha: false } );
      renderer.setSize( window.innerWidth, window.innerHeight );

      container.appendChild( renderer.domElement );

      window.addEventListener( 'resize', onWindowResize, false );
    }

    function onWindowResize( event ) {

      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();

      renderer.setSize( window.innerWidth, window.innerHeight );

    }

    function animate() {

      requestAnimationFrame( animate );

      position = ( ( Date.now() - start_time ) * 0.03 ) % 8000;

      camera.position.z = - position + 8000;

      sky.uniforms.reileigh.value += 0.005;
      sunSphere.position.y -= 50;

      renderer.render( scene, camera );

    }
  </script>
</body>
</html>